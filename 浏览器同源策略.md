# 浏览器同源策略

## 什么是同源策略

同源策略是一种安全机制，用于浏览器中限制不同源之间的交互。这个机制主要用于隔离潜在的有害文档，预防可能的攻击。需要注意，同源策略保护的是资源所在的源，而非请求资源的源。

所谓同源是指两个源具备相同协议、域名、端口，下表给出了与 URL http[]()://store.company.com/dir/page.html 的源进行对比的示栗：

| URL | 结果	| 原因 |
| ---- | ---- | ---- |
| http[]()://store.company.com/dir2/other.html | 同源 | |
| http[]()://store.company.com/dir/inner/another.html | 同源 | |
| https[]()://store.company.com/secure.html | 不同源 | 协议不同 |
| http[]()://news.company.com/dir/other.html | 不同源 | 域名不同 |
| http[]()://store.company.com:81/dir/etc.html | 不同源 | 端口不同 |

所谓跨域就是当前发起请求的源与请求所指向的源不同源。

在浏览器中，&lt;script>、&lt;img>、&lt;link>、&lt;form>、&lt;iframe>、&lt;a>等标签是允许跨域的，但是如果link了一个css文件，而css文件里通过@font-face的url引入了字体，那么会出现跨域问题。这些标签不受浏览器同源策略的限制，每次加载的时候，实际上都是浏览器发起的一次GET请求。

浏览器同源策略中，除了上述的几个标签可以跨域加载外，其他出现跨域请求时，请求会发送到跨域的服务器，并且服务器会返回数据，只不过浏览器“拒收”返回的数据。

浏览器的同源策略的目的是为了保护用户的信息安全，为了防止恶意网站窃取用户在浏览器上的数据，如果不是同源的站点，将不能进行如下操作：

- cookie、localStorage、sessionStorage、indexedDB无法读写

- DOM无法获取

- AJAX请求不能发送

## 如何解决跨域问题

### JSONP

JSONP（JSON with Padding）的本质是，利用script标签的src属性不受同源策略的影响，通过带有参数和回调函数的url发起一次get请求（这也是jsonp只能发起get请求的原因，因为只有get请求才能把参数和回调函数拼接到url中），服务器将接口返回的数据拼凑到回调函数中，返回给浏览器，浏览器解析执行，从而前端拿到回调函数返回的数据。

示栗：

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <script>
    function fn(data) {
      console.log(data)
    }
  </script>
  <!-- 将非同源服务端请求地址写在script标签的src属性中 -->
  <script src="https://api.map.baidu.com/geocoder/v2/?ak=KOmVjPVUAey1G2E8zNhPiuQ6QiEmAwZu&location=22.580200,113.948680&output=json&callback=fn"></script>
</body>
</html>
```

### CORS

跨域资源共享（Cross-Origin Resource Sharing，CORS）是一种机制，它使用额外的http头来告诉浏览器，让运行在一个origin上的web应用被准许访问来自不同源服务器上的指定资源。当一个资源从该资源本身所在的服务器不同的域，协议或端口请求一个资源时，资源会发起一个跨域HTTP请求。实现CORS的关键是服务器，只要服务器实现了CORS请求，就可以跨源通信了。

CORS的实现方式很简单，当使用XMLHttpRequest发送请求时，浏览器发现该请求不符合同源策略，会给该请求加一个请求头：Origin，，后台进行一系列处理，如果确定接收请求则在返回结果中加入一个响应头：Access-Control-Allow-Origin；浏览器判断响应头中是否包含Origin的值，如果有则浏览器会处理响应，我们就可以拿到响应数据，如果不包含浏览器直接驳回，这时我们无法拿到响应数据。所以CORS的表象是让你觉得它与同源的ajax请求没啥区别，代码完全一样。

### 服务器代理

同源策略是仅针对浏览器的安全策略。服务端调用http接口只是使用http协议，不需要同源策略，也就不存在跨域问题。
